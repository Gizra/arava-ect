"use strict";angular.module("negawattClientApp",["angularMoment","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive","config","LocalStorageModule","ui.router","googlechart","angular-md5","angular-loading-bar"]).config(["$stateProvider","$urlRouterProvider","$httpProvider","cfpLoadingBarProvider",function(a,b,c,d){b.otherwise("/"),a.state("login",{url:"/login",templateUrl:"views/login.html"}).state("dashboard",{url:"",templateUrl:"views/dashboard/main.html",resolve:{profile:["Profile",function(a){return a.get()}]},controller:"DashboardCtrl"}).state("dashboard.withAccount",{"abstract":!0,url:"/dashboard/{accountId:int}",resolve:{account:["$stateParams","Profile","profile",function(a,b,c){return b.selectAccount(a.accountId,c)}],categories:["Category","account",function(a,b){return a.get(b.id)}],meters:["Meter","account",function(a,b){return a.get(b.id)}]}}).state("dashboard.withAccount.preload",{url:"",views:{"menu@dashboard":{templateUrl:"views/dashboard/main.menu.html",controller:"MenuCtrl"},"map@dashboard":{templateUrl:"views/dashboard/main.map.html",controller:"MapCtrl"},"categories@dashboard":{templateUrl:"views/dashboard/main.categories.html",controller:"CategoryCtrl"},"messages@dashboard":{templateUrl:"views/dashboard/main.messages.html",resolve:{messages:["Message",function(a){return a.get()}]},controller:"MessageCtrl"},"usage@dashboard":{templateUrl:"views/dashboard/main.usage.html",resolve:{usage:["ChartUsage",function(a){return a.get()}]},controller:"UsageCtrl"},"details@dashboard":{templateUrl:"views/dashboard/main.details.html",resolve:{categoriesChart:["ChartCategories","account",function(a,b){return a.get(b.id)}]},controller:"DetailsCtrl"}}}).state("dashboard.withAccount.preload.categories",{url:"/category/{categoryId:int}",views:{"map@dashboard":{templateUrl:"views/dashboard/main.map.html",resolve:{meters:["Meter","$stateParams","account",function(a,b,c){return a.get(c.id,b.categoryId)}]},controller:"MapCtrl"},"details@dashboard":{templateUrl:"views/dashboard/main.details.html",resolve:{categoriesChart:["ChartCategories","$stateParams","account",function(a,b,c){return a.get(c.id,b.categoryId)}]},controller:"DetailsCtrl"},"categories@dashboard":{templateUrl:"views/dashboard/main.categories.html",controller:"CategoryCtrl"}}}).state("dashboard.withAccount.preload.markers",{url:"/marker/:markerId?categoryId",views:{"map@dashboard":{templateUrl:"views/dashboard/main.map.html",controller:"MapCtrl"},"details@dashboard":{templateUrl:"views/dashboard/main.details.html",resolve:{categoriesChart:angular.noop},controller:"DetailsCtrl"},"usage@dashboard":{templateUrl:"views/dashboard/main.usage.html",resolve:{meters:["$stateParams","Meter","meters","account",function(a,b,c,d){return b.get(d.id,a.categoryId)}],usage:["ChartUsage","$stateParams",function(a,b){return a.get("meter",b.markerId)}]},controller:"UsageCtrl"},"categories@dashboard":{templateUrl:"views/dashboard/main.categories.html",controller:"CategoryCtrl"}}}),c.interceptors.push(["$q","Auth","$location","localStorageService",function(a,b,c,d){return{request:function(a){return a.url.match(/login-token/)||(a.headers={access_token:d.get("access_token")}),a},response:function(a){return a.data.access_token&&d.set("access_token",a.data.access_token),a},responseError:function(c){return 401===c.status&&b.authFailed(),a.reject(c)}}}]),d.includeSpinner=!1,d.latencyThreshold=1e3}]).run(["$rootScope","$state","$stateParams","$log","Config",function(a,b,c,d,e){a.$state=b,a.$stateParams=c,e.debugUiRouter&&(a.$on("$stateChangeStart",function(a,b,c){d.log("$stateChangeStart to "+b.to+"- fired when the transition begins. toState,toParams : \n",b,c)}),a.$on("$stateChangeError",function(){d.log("$stateChangeError - fired when an error occurs during transition."),d.log(arguments)}),a.$on("$stateChangeSuccess",function(a,b){d.log("$stateChangeSuccess to "+b.name+"- fired once the state transition is complete.")}),a.$on("$viewContentLoaded",function(a){d.log("$viewContentLoaded - fired after dom rendered",a)}),a.$on("$stateNotFound",function(a,b,c,e){d.log("$stateNotFound "+b.to+"  - fired when a state cannot be found by its name."),d.log(b,c,e)}))}]),angular.module("negawattClientApp").controller("AccessCtrl",["$scope","$state","Auth","Profile",function(a,b,c){a.loginButtonEnabled=!0,a.loginFailed=!1,a.login=function(d){a.loginButtonEnabled=!1,c.login(d).then(function(){b.go("dashboard")},function(){b.go("login"),a.loginButtonEnabled=!0,a.loginFailed=!0})},a.logout=function(){c.logout(),b.go("login")}}]),angular.module("negawattClientApp").controller("DashboardCtrl",["$state","profile",function(a,b){var c;b?(c=b.account[0].id,a.go("dashboard.withAccount.preload",{accountId:c})):a.go("login")}]),angular.module("negawattClientApp").controller("UsageCtrl",["$scope","$stateParams","usage","meters","ChartUsage",function(a,b,c,d,e){a.usageChart=c,angular.isDefined(b.markerId)&&(a.meterSelected=d[b.markerId],e.meterSelected(d[b.markerId]))}]),angular.module("negawattClientApp").controller("MapCtrl",["$scope","$state","$stateParams","Category","ChartUsage","Map","leafletData","$timeout","account","meters",function(a,b,c,d,e,f,g,h,i,j){function k(b){h(function(){var c=f.getMarkerSelected();angular.isDefined(c)&&angular.isDefined(a.meters[c])&&a.meters[f.getMarkerSelected()].unselect(),angular.isDefined(a.meters[b])&&(a.meters[b].select(),f.setMarkerSelected(b))})}a.defaults=f.getConfig(),a.center=f.getCenter(i),a.meters=j,a.$on("leafletDirectiveMarker.mouseover",function(a,b){var d=b.markerName;if(c.openedPopup!==d){c.openedPopup=d;var e=b.leafletEvent.target;e.openPopup()}}),a.$on("leafletDirectiveMarker.mouseout",function(a,b){var d=b.leafletEvent.target;d.closePopup(),c.openedPopup=null}),a.$on("leafletDirectiveMap.dragend",function(){g.getMap().then(function(a){f.setCenter(a.getCenter())})}),a.$on("leafletDirectiveMap.zoomend",function(){g.getMap().then(function(a){f.updateCenterZoom(a.getZoom())})}),a.$on("nwMetersChanged",function(b,c){a.meters=c}),a.$on("leafletDirectiveMarker.click",function(a,c){b.go("dashboard.withAccount.preload.markers",{markerId:c.markerName,categoryId:d.getSelectedCategory()})}),c.markerId&&k(c.markerId)}]),angular.module("negawattClientApp").controller("CategoryCtrl",["$scope","$state","$stateParams","Category","categories",function(a,b,c,d,e){function f(a){d.setSelectedCategory(a)}a.categories=e,a.allCategories=e,a.accountId=c.accountId,a.hasMeters=function(a){return!!a.meters},c.categoryId&&f(c.categoryId)}]),angular.module("negawattClientApp").controller("DetailsCtrl",["$scope","$state","$stateParams","ChartCategories","categoriesChart","meters",function(a,b,c,d,e,f){function g(b){a.meterSelected=f[b]}var h;a.categoriesChart=e,a.onSelect=function(a,e){h=d.getCategoryIdSelected(a,e),angular.isDefined(h)&&b.go("dashboard.withAccount.preload.categories",{accountId:c.accountId,categoryId:h})},c.markerId&&g(c.markerId)}]),angular.module("negawattClientApp").controller("MenuCtrl",["$scope","$state","$stateParams","Category","account","profile",function(a,b,c,d,e,f){a.account=e,a.user=f.user,a.reloadDashboard=function(){d.setSelectedCategory(),b.go("dashboard.withAccount.preload",{accountId:c.accountId},{reload:!0})}}]),angular.module("negawattClientApp").controller("MessageCtrl",["$scope","$state","messages",function(a,b,c){a.messages=c}]),angular.module("negawattClientApp").service("Meter",["$q","$http","$timeout","$filter","$state","$rootScope","Config","Marker","Utils",function(a,b,c,d,e,f,g,h,i){function j(c,d){var e,f=a.defer();return d=d||1,e=g.backend+"/api/iec_meters?filter[account]="+c+"&page="+d,b({method:"GET",url:e,transformResponse:m}).success(function(a){k(a.data),f.resolve(a.data),a.hasNextPage&&(r=!0,j(c,o(a.hasNextPage.href))),l()}),f.promise}function k(a){q={data:angular.extend(q.data||{},a),timestamp:new Date},f.$broadcast(s,q.data),r=!1}function l(){r||c(function(){q.data=void 0},6e5)}function m(a){var b={};return a=angular.fromJson(a),b={data:i.indexById(a.data),hasNextPage:a.next||!1},angular.forEach(b.data,function(a){b.data[a.id]=a,a.location&&(b.data[a.id].lat=parseFloat(a.location.lat),b.data[a.id].lng=parseFloat(a.location.lng),delete a.location),b.data[a.id].message=a.place_description+"<br>"+a.place_address+"<br>"+a.place_locality,angular.extend(b.data[a.id],h),b.data[a.id].unselect()}),b}function n(b,c){var e=a.defer();return b.then(function(a){a=i.indexById(d("filter")(i.toArray(a),function(a){return a.meter_categories&&(a.meter_categories=a.meter_categories.map(function(a){return parseInt(a)})),a.meter_categories&&-1!==a.meter_categories.indexOf(parseInt(c))?a:void 0},!0)),e.resolve(a)}),e.promise}function o(a){var b=/.*page=([0-9]*)/;return b.exec(a).pop()}var p,q={},r=!1,s="nwMetersChanged";this.get=function(b,c){return p=a.when(p||angular.copy(q.data)||j(b)),angular.isDefined(c)&&(p=n(p,c)),p["finally"](function(){p=void 0}),p},f.$on("nwClearCache",function(){q={}})}]),angular.module("negawattClientApp").service("Category",["$q","$http","$timeout","$state","$rootScope","$filter","Config","Utils","Meter",function(a,b,c,d,e,f,g,h,i){function j(){var c=a.defer(),d=g.backend+"/api/meter_categories";return b({method:"GET",url:d,cache:!0}).success(function(a){c.resolve(a.data)}),c.promise}function k(b,c){var d=a.defer();return b.then(function(a){a=angular.copy(a),a.collection=f("filter")(h.toArray(a.collection),{id:parseInt(c)},!0).pop().children,d.resolve(a)}),d.promise}function l(a){u={data:a,timestamp:new Date},c(function(){u.data=void 0},6e4),e.$broadcast(v)}function m(b,c){var d=a.defer();return i.get(c).then(function(a){t.meters=h.toArray(a),b.then(n).then(o).then(function(a){l(a),d.resolve(u.data)})}),d.promise}function n(b){var c,d=a.defer(),e=angular.isArray(b)?b:b.list;return angular.forEach(e,function(a){a.meters=0},e),t.indexed=h.indexById(e),c=t.meters.map(function(a){return a.meter_categories?a.meter_categories:[]}),angular.forEach(c,function(a){angular.forEach(a,function(a){var b=[parseInt(a)];angular.forEach(b,function(a){t.indexed[a].meters++})})}),e=h.toArray(t.indexed),d.resolve(e),d.promise}function o(b){var c=a.defer(),d={};return d.list=b,d.collection=p(b),d.tree=q(b),c.resolve(d),c.promise}function p(a){return h.indexById(a)}function q(a){var b;return a=r(a),b=f("filter")(a,{depth:0})}function r(a){var b=h.indexById(a),c=[];return angular.forEach(a,function(a){angular.forEach(a.children,function(c,d){angular.isString(c)&&(a.children[d]=b[c])}),this.push(a)},c),a}var s,t=this,u={},v="nwCategoriesChanged";this.getSelectedCategory=function(){return u.selected},this.setSelectedCategory=function(a){u.selected=a},this.get=function(b,c){return s=a.when(s||angular.copy(u.data)||j()),s=m(s,b),angular.isDefined(c)&&(s=k(s,c)),s["finally"](function(){s=void 0}),s},e.$on("nwClearCache",function(){u={}})}]),angular.module("negawattClientApp").service("ChartUsage",["$q","Electricity","moment",function(a,b,c){var d=this;this.get=function(c,e){var f=a.defer(),g=Math.floor(Date.now()/1e3)-63072e3,h={type:"2",timestamp:{value:g,operator:">"}};return c&&(h[c]=e),b.get(h).then(function(a){d.usageChartParams=d.transformDataToDatasets(a),f.resolve(d.usageChartParams)}),f.promise},this.meterSelected=function(a){var b="צריכת חשמל";this.usageChartParams&&(b=a.place_description+", "+a.place_address+", "+a.place_locality,this.usageChartParams.options.title=b)},this.transformDataToDatasets=function(a){var b={};angular.forEach(a,function(a){a.timestamp in b||(b[a.timestamp]={}),a.rate_type in b[a.timestamp]||(b[a.timestamp][a.rate_type]=0),b[a.timestamp][a.rate_type]+=+a.kwh});var d=[{id:"month",label:"Month",type:"string",p:{}},{id:"flat",label:"אחיד",type:"number",p:{}},{id:"peak",label:"פסגה",type:"number",p:{}},{id:"mid",label:"גבע",type:"number",p:{}},{id:"low",label:"שפל",type:"number",p:{}}],e=[];angular.forEach(b,function(a,b){var d=c.unix(b).format("MM-YYYY"),f=[{v:d},{v:a.flat},{v:a.peak},{v:a.mid},{v:a.low}];e.push({c:f})});var f={type:"ColumnChart",cssStyle:"height:210px; width:500px;",data:{cols:d,rows:e},options:{isStacked:"true",bar:{groupWidth:"75%"},fill:20,displayExactValues:!0,vAxis:{title:'קוט"ש בחודש',gridlines:{count:6}},hAxis:{title:"חודש"}},formatters:{},displayed:!0};return f}}]),angular.module("negawattClientApp").service("ChartCategories",["$q","$filter","Category","Utils",function(a,b,c,d){function e(a,b){var c=g(a,b);return a.type="PieChart",a.data={cols:[{id:"t",label:"Categories",type:"string"},{id:"s",label:"Slices",type:"number"}],rows:f(a,c)},a}function f(a,c){var e=[];return a=b("filter")(d.toArray(a),function(a){return a.meters>0&&a.depth===c?a:void 0}),angular.forEach(a,function(a){this.push({c:[{v:a.label},{v:a.meters},{id:a.id}]})},e),e}function g(a,b){var c=0;return angular.isDefined(b)&&a&&(c=a[0].depth),c}this.get=function(b,d){var f=a.defer();return c.get(b,d).then(function(a){f.resolve(a.collection?e(a.collection,d):{})}),f.promise},this.getCategoryIdSelected=function(a,b){return b.rows[a.row].c[2].id}}]),angular.module("negawattClientApp").service("Electricity",["$q","$http","$timeout","$rootScope","Config","md5",function(a,b,c,d,e,f){function g(c,d){var f=a.defer(),g=e.backend+"/api/electricity",i={};return c&&(i={},angular.forEach(c,function(a,b){"object"==typeof a?angular.forEach(a,function(a,c){i["filter["+b+"]["+c+"]"]=a}):i["filter["+b+"]"]=a})),b({method:"GET",url:g,params:i,cache:!0}).success(function(a){h(a.electricity,d),f.resolve(j[d].data)}),f.promise}function h(a,b){j[b]={data:a,timestamp:new Date},k.push(c(function(){angular.isDefined(j[b])&&(j[b].data=void 0)},6e4)),d.$broadcast(l)}var i,j={},k=[],l="nwElectricityChanged";this.get=function(b){var c=f.createHash(JSON.stringify(b));return i=a.when(i||j[c]&&j[c].data||g(b,c)),i["finally"](function(){i=void 0}),i},d.$on("nwClearCache",function(){j={},angular.forEach(k,function(a){c.cancel(a)}),k=[]})}]),angular.module("negawattClientApp").service("Auth",["$injector","$rootScope","Utils","localStorageService","Config",function(a,b,c,d,e){this.login=function(b){return a.get("$http")({method:"GET",url:e.backend+"/api/login-token",headers:{Authorization:"Basic "+c.Base64.encode(b.username+":"+b.password)},cache:!0})},this.logout=function(){d.remove("access_token"),b.$broadcast("nwClearCache")},this.isAuthenticated=function(){return!!d.get("access_token")},this.authFailed=function(){a.get("$state").go("login"),this.logout()}}]),angular.module("negawattClientApp").service("Map",["$rootScope","leafletData",function(a,b){var c=this,d={},e="nwMapChanged";this.getConfig=function(){return{tileLayer:"https://{s}.tiles.mapbox.com/v3/examples.map-i87786ca/{z}/{x}/{y}.png",zoomControlPosition:"bottomleft",minZoom:8,maxZoom:16}},this.setCenter=function(b){d.center=angular.extend(d.center||{},b),a.$broadcast(e)},this.updateCenterZoom=function(a){angular.isDefined(d.center)&&(d.center.zoom=a)},this.getCenter=function(a){return angular.isUndefined(d.center)&&angular.isDefined(a.center)&&c.setCenter(a.center),angular.copy(d.center)},this.centerMapByMarker=function(a){b.getMap().then(function(b){c.setCenter(a.getPosition()),b.setView(c.getCenter())})},this.setMarkerSelected=function(a){d.markerSelected=a},this.getMarkerSelected=function(){return d.markerSelected},a.$on("nwClearCache",function(){d={}})}]),angular.module("negawattClientApp").factory("Marker",["$state","Map",function(a,b){function c(a){return e[a]}var d,e={"default":{iconUrl:"../images/marker-blue.png",shadowUrl:"../images/shadow.png",iconSize:[40,40],shadowSize:[26,26],iconAnchor:[32,30],shadowAnchor:[25,7],popupAnchor:[-10,-25]},selected:{iconUrl:"../images/marker-red.png",shadowUrl:"../images/shadow.png",iconSize:[40,40],shadowSize:[26,26],iconAnchor:[32,30],shadowAnchor:[25,7],popupAnchor:[-10,-25]}};return{getSelected:function(){return d},unselect:function(){this.icon=c("default")},select:function(){angular.isDefined(d)&&d.unselect(),d=this,this.icon=c("selected"),b.centerMapByMarker(this)},getPosition:function(){return{lat:this.lat,lng:this.lng}}}}]),angular.module("negawattClientApp").service("Message",["$q","$http","$rootScope","$state","$timeout","$sce","Config",function(a,b,c,d,e,f,g){function h(){var c=a.defer(),d=g.backend+"/api/anomalous_consumption";return b({method:"GET",url:d,transformResponse:i,cache:!0}).success(function(a){j(a),c.resolve(k.data)}),c.promise}function i(a){var b=angular.fromJson(a).data;return angular.forEach(b,function(a){angular.isDefined(a["long-text"])&&(a["long-text"]=a["long-text"].replace("%23","#"),a["long-text"]=a["long-text"].replace("90","50")),angular.isDefined(a.text)&&(a.text=a.text.replace("90","50"),a.text=a.text.replace("%23","#"))}),b}function j(a){k={data:a,timestamp:new Date},e(function(){k.data=void 0},6e4),c.$broadcast(l)}var k={},l="nwMessagesChanged";this.get=function(){return a.when(k.data||h())},c.$on("nwClearCache",function(){k={}})}]),angular.module("negawattClientApp").service("Profile",["$q","$http","$timeout","$filter","$state","$rootScope","Config",function(a,b,c,d,e,f,g){function h(){var b,c=a.defer();return b=a.all([i(),j()]),b.then(function(a){k(a),c.resolve(o.data)}),c.promise}function i(){var a=g.backend+"/api/me";return b({method:"GET",url:a,transformResponse:l,cache:!0})}function j(){var a=g.backend+"/api/accounts";return b({method:"GET",url:a,transformResponse:m,cache:!0})}function k(a){o={data:{user:a[0].data,account:a[1].data},timestamp:new Date},c(function(){o.data=void 0},6e4),f.$broadcast(p)}function l(a){return angular.fromJson(a).data}function m(a){if(a){var b=angular.fromJson(a);if(b)return angular.forEach(b.data,function(a){a.center={lat:parseFloat(a.location.lat),lng:parseFloat(a.location.lng),zoom:parseInt(a.zoom)},delete a.location,delete a.zoom}),b.data}}var n,o={},p="nwProfileChanged";this.get=function(){return a.when(o.data||h())},this.selectAccount=function(a,b){var c;return c=d("filter")(b.account,{id:a}),b.account.map(function(c,d){return c.id===a?void b.account.splice(d,1):void 0}),b.account.unshift(c.pop()),n!==b.account[0].id&&f.$broadcast("nwClearCache"),b.account[0]},f.$on("nwClearCache",function(){o={}})}]),angular.module("negawattClientApp").service("Utils",function(){var a=this;this.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(b){var c,d,e,f,g,h,i,j="",k=0;for(b=a.Base64._utf8_encode(b);k<b.length;)c=b.charCodeAt(k++),d=b.charCodeAt(k++),e=b.charCodeAt(k++),f=c>>2,g=(3&c)<<4|d>>4,h=(15&d)<<2|e>>6,i=63&e,isNaN(d)?h=i=64:isNaN(e)&&(i=64),j=j+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h)+this._keyStr.charAt(i);return j},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}},this.indexById=function(a){var b={};return angular.forEach(a,function(a){this[a.id]=a},b),b},this.toArray=function(a){var b=[];return angular.forEach(a,function(a){this.push(a)},b),b}}),angular.module("negawattClientApp").directive("loadingBarText",function(){return{restrict:"EA",template:'<div class="splash-screen" ng-show="isLoading">{{text}}</div>',controller:["$scope",function(a){function b(b){a.isLoading=b}a.text="טוען...",a.isLoading=!1,a.$on("cfpLoadingBar:started",function(){b(!0)}),a.$on("cfpLoadingBar:completed",function(){b(!1)})}],scope:{}}});