<?php

/**
 * @file
 * Contains NegawattNormalizerMeterProcessTestCase
 */

class NegawattNormalizerMeterProcessTestCase extends NegawattWebTestCase {

  /**
   * Get test info.
   *
   * @return array
   *    test info
   */
  public static function getInfo() {
    return array(
      'name' => 'Normalizer process',
      'description' => 'Test the processing of raw data by normalizers.',
      'group' => 'Negawatt Normalizer',
    );
  }

  /**
   * Setup test environment.
   * Prepare meter nodes and raw data entities.
   */
  function setUp() {
    parent::setUp('negawatt_normalizer');

    // Create satec meter nodes.
    $settings = array(
      'type' => 'satec_meter',
    );

    $meter_node1 = $this->drupalCreateNode($settings);
    $meter_node2 = $this->drupalCreateNode($settings);

    // Set field_last_processed for nodes.
    $wrapper = entity_metadata_wrapper('node', $meter_node1);
    $wrapper->field_last_processed->set(strtotime('2014-6-12 15:00'));
    $wrapper->save();

    $wrapper = entity_metadata_wrapper('node', $meter_node2);
    $wrapper->field_last_processed->set(strtotime('2014-6-12 15:00'));
    $wrapper->save();

    // Create IEC meter nodes.
    $settings = array(
      'type' => 'iec_meter',
    );

    $meter_node3 = $this->drupalCreateNode($settings);
    $meter_node4 = $this->drupalCreateNode($settings);

    // Set field_last_processed for nodes.
    $wrapper = entity_metadata_wrapper('node', $meter_node3);
    $wrapper->field_last_processed->set(strtotime('2014-2-1 00:00'));
    $wrapper->save();

    // Save nodes for later.
    $this->meterNode1 = $meter_node1;
    $this->meterNode2 = $meter_node2;
    $this->meterNode3 = $meter_node3;
    $this->meterNode4 = $meter_node4;

    // @todo: Add frequency.
    // $wrapper = entity_metadata_wrapper('node', $meter_node);
    // $wrapper->field_meter_frequency-set();

    // Create the raw data.
    $values_info = array(
      array(
        // Two SATEC entries for hour 15:00.
        'type' => 'SATEC',
        'timestamp' => strtotime('2014-6-12 15:00'),
        'rate_type' => 'flat',
        'meter_nid' => $meter_node1->nid,
        'kwh' => 10,
        'power_factor' => 0.90,
      ),
      array(
        'type' => 'SATEC',
        'timestamp' => strtotime('2014-6-12 15:01'),
        'rate_type' => 'flat',
        'meter_nid' => $meter_node1->nid,
        'kwh' => 20,
        'power_factor' => 0.96,
      ),
      // One entry for meter 2, should not be read.
      array(
        'type' => 'SATEC',
        'timestamp' => strtotime('2014-6-12 15:01'),
        'rate_type' => 'flat',
        'meter_nid' => $meter_node2->nid,
        'kwh' => 30,
        'power_factor' => 0.96,
      ),
      // IEC 4 rate-type entries for 2/2014.
      array(
        'type' => 'IEC',
        'timestamp' => strtotime('2014-2-1 00:00'),
        'rate_type' => 'flat',
        'meter_nid' => $meter_node3->nid,
        'kwh' => 1*24*28,
        'power_factor' => 0.96,
      ),
      array(
        'type' => 'IEC',
        'timestamp' => strtotime('2014-2-1 00:00'),
        'rate_type' => 'low',
        'meter_nid' => $meter_node3->nid,
        'kwh' => 2*24*28,
        'power_factor' => 0.97,
      ),
      array(
        'type' => 'IEC',
        'timestamp' => strtotime('2014-2-1 00:00'),
        'rate_type' => 'mid',
        'meter_nid' => $meter_node3->nid,
        'kwh' => 3*24*28,
        'power_factor' => 0.98,
      ),
      array(
        'type' => 'IEC',
        'timestamp' => strtotime('2014-2-1 00:00'),
        'rate_type' => 'peak',
        'meter_nid' => $meter_node3->nid,
        'kwh' => 4*24*28,
        'power_factor' => 0.99,
      ),
      // Only two rate-types in the 3/2014
      array(
        'type' => 'IEC',
        'timestamp' => strtotime('2014-3-1 00:00'),
        'rate_type' => 'mid',
        'meter_nid' => $meter_node3->nid,
        'kwh' => 1*24*31,
        'power_factor' => 0.91,
      ),
      array(
        'type' => 'IEC',
        'timestamp' => strtotime('2014-3-1 00:00'),
        'rate_type' => 'peak',
        'meter_nid' => $meter_node3->nid,
        'kwh' => 2*24*31,
        'power_factor' => 0.92,
      ),
      // Just to make sure, additional value that will not be read in the test
      array(
        'type' => 'IEC',
        'timestamp' => strtotime('2014-4-1 00:00'),
        'rate_type' => 'flat',
        'meter_nid' => $meter_node3->nid,
        'kwh' => 5*24*30,
        'power_factor' => 0.93,
      ),
      // And another value for meter 4
      array(
        'type' => 'IEC',
        'timestamp' => strtotime('2014-2-2 13:56'),
        'rate_type' => 'flat',
        'meter_nid' => $meter_node4->nid,
        'kwh' => 7896,
        'power_factor' => 0.92,
      ),
    );

    foreach ($values_info as $values) {
      $entity = entity_create('electricity_raw', $values);
      $entity->save();
    }
  }

  /**
   * Test processing a SATEC meter.
   * - @todo: Test meter with wrong frequency
   * - Test meter with empty data
   * - Test meter with valid data.
   * - Test that the using same timestamp, nid returns an existing entity.
   * - Test that adding raw data and calling process again returns proper values.
   */
  function testProcessSatecMeter() {

    $handler = negawatt_normalizer_get_electricity_normalizer_handler('satec');

    // Call process() with no raw data.
    $result_entities = $handler->process($this->meterNode1,
      array(\ElectricityNormalizerInterface::HOUR),
      array(strtotime('2014-3-1 12:00'),strtotime('2014-3-1 12:00')),
      array('flat'));

    // Should be empty array.
    // @todo: We have to decide if we return NULL here or some kind of an empty entity
    $this->assertTrue(is_array($result_entities) && empty($result_entities), 'process() with no data returns an empty array.');

    // Create a new normalized entity and check its validity.
    $result_entities = $handler->process($this->meterNode1,
      array(\ElectricityNormalizerInterface::HOUR),
      array(strtotime('2014-6-12 16:00'),strtotime('2014-6-12 16:00')),
      array('flat'));

    $this->assertTrue(is_array($result_entities) && count($result_entities) == 1, 'process() returns an array with one object.');
    $result_entity = $result_entities[0];

    $id = $result_entity->id;

    $this->assertEqual($result_entity->type, \ElectricityNormalizerInterface::HOUR, '<b>Testing SATEC normalizer</b><br>Entity type is correct.');
    $this->assertEqual($result_entity->timestamp, strtotime('2014-6-12 15:00'), 'Processed timestamp is correct.');
    $this->assertEqual($result_entity->meter_nid, 1, 'Meter nid is correct.');
    $this->assertEqual($result_entity->avg_power, 600, 'Average power calculation was correct.');
    // Problem with float representation prevent the exact value of 0.9
    $this->assertTrue(abs($result_entity->min_power_factor - 0.90) < 0.0001, 'Min power-factor calculation was correct.');

    // Add new entity to electricity raw table.
    $values = array(
      'type' => 'SATEC',
      'timestamp' => strtotime('2014-6-12 15:04'),
      'rate_type' => 'flat',
      'meter_nid' => $this->meterNode1->nid,
      'kwh' => 30,
      // Supply a new minimal power factor of 0.89 (previous value as 0.90).
      'power_factor' => 0.89,
    );
    $entity = entity_create('electricity_raw', $values);
    $entity->save();

    // Use same process params again.
    $result_entities = $handler->process($this->meterNode1,
      array(\ElectricityNormalizerInterface::HOUR),
      array(strtotime('2014-6-12 16:00'),strtotime('2014-6-12 16:00')),
      array('flat'));
    $result_entity = $result_entities[0];

    // Make sure the same normalized entity is returned.
    $this->assertEqual($result_entity->id, $id, '<b>Second call to process().</b><br>The existing electricity entity is used.');

    // Check that the values were updated after new entry.
    $this->assertEqual($result_entity->type, \ElectricityNormalizerInterface::HOUR, 'Entity type is correct.');
    $this->assertEqual($result_entity->timestamp, strtotime('2014-6-12 15:00'), 'Processed timestamp is correct.');
    $this->assertEqual($result_entity->meter_nid, 1, 'Meter nid is correct.');
    $this->assertEqual($result_entity->avg_power, 300, 'Average power calculation was correct.');
    $this->assertTrue(abs($result_entity->min_power_factor - 0.89) < 0.0001, 'Min power-factor calculation was correct.');
  }

  /**
   * Test processing an IEC meter.
   * - @todo: Test meter with wrong frequency
   * - Test meter with empty data
   * - Test meter with valid data.
   * - Test that the using same timestamp, nid returns an existing entity.
   * - Test that changing raw data and calling process again returns proper values.
   * - Test several rate-types
   */
  function testProcessIecMeter() {

    $handler = negawatt_normalizer_get_electricity_normalizer_handler('iec');

    // Call process() with frequency lower then MONTH, should raise an Exception.
    $message = '<b>Testing IEC normalizer.</b><br>Calling process() with frequency lower than MONTH.';
    try {
      $handler->process($this->meterNode3,
        array(\ElectricityNormalizerInterface::DAY),
        array(strtotime('2014-3-1 00:00'),strtotime('2014-3-1 00:00')),
        array('low'));
      $this->fail($message);
    }
    catch(Exception $e) {
      $this->pass($message);
    }

    // Call process() with no raw data, but with rate-type, should return an tmpty array.
    $result_entities = $handler->process($this->meterNode3,
      array(\ElectricityNormalizerInterface::MONTH),
      array(strtotime('2013-5-1 00:00'),strtotime('2013-5-1 00:00')),
      array('low'));
    $this->assertTrue(is_array($result_entities) && empty($result_entities), 'Calling process() with no raw data (with rate-type), returns empty array.');

    // Call process() with no raw data, but without rate-type, should return emtpy array.
    $result_entities = $handler->process($this->meterNode3,
      array(\ElectricityNormalizerInterface::MONTH),
      array(strtotime('2013-5-1 00:00'), strtotime('2013-5-1 00:00')));
    $this->assertTrue(is_array($result_entities) && empty($result_entities), 'Calling process() with no raw data (without rate-type), returns emtpy array.');

    // Create a new normalized entity and check its validity.
    $result_entities = $handler->process($this->meterNode3,
      array(\ElectricityNormalizerInterface::MONTH),
      array(strtotime('2014-3-1 00:00'), strtotime('2014-3-1 00:00')),
      array('low'));

    $this->assertTrue(is_array($result_entities) && count($result_entities) == 1, 'process() returns an array with one object.');
    $result_entity = $result_entities[0];

    $id = $result_entity->id;

    $this->assertEqual($result_entity->type, \ElectricityNormalizerInterface::MONTH, 'Entity type is correct.');
    $this->assertEqual($result_entity->timestamp, strtotime('2014-2-1 00:00'), 'Processed timestamp is correct.');
    $this->assertEqual($result_entity->meter_nid, 3, 'Meter nid is correct.');
    $this->assertEqual($result_entity->avg_power, 2, 'Average power calculation was correct.');
    $this->assertTrue(abs($result_entity->min_power_factor - 0.97) < 0.0001, 'Min power-factor calculation was correct.');

    // Modify an entity in electricity raw table.
    $entity = entity_load('electricity_raw', array(5));
    $entity = $entity[5];
    $entity->kwh = 3360;
    $entity->power_factor = 0.90;
    $entity->save();

    // Use same process params again.
    $result_entities = $handler->process($this->meterNode3,
      array(\ElectricityNormalizerInterface::MONTH),
      array(strtotime('2014-3-1 00:00'), strtotime('2014-3-1 00:00')),
      array('low'));
    $result_entity = $result_entities[0];

    // Make sure the same normalized entity is returned.
    $this->assertEqual($result_entity->id, $id, '<b>Second call to process().</b><br>The existing electricity entity is used.');

    // Check that the values were updated after new entry.
    $this->assertEqual($result_entity->type, \ElectricityNormalizerInterface::MONTH, 'Entity type is correct.');
    $this->assertEqual($result_entity->timestamp, strtotime('2014-2-1 00:00'), 'Processed timestamp is correct.');
    $this->assertEqual($result_entity->meter_nid, 3, 'Meter nid is correct.');
    $this->assertEqual($result_entity->avg_power, 5, 'Average power calculation was correct.');
    $this->assertTrue(abs($result_entity->min_power_factor - 0.90) < 0.0001, 'Min power-factor calculation was correct.');

    // Call process() without rate-type.
    $result_entities = $handler->process($this->meterNode3,
      array(\ElectricityNormalizerInterface::MONTH),
      array(strtotime('2014-3-1 00:00'), strtotime('2014-3-1 00:00')));

    // Should return an array of 4 objects.
    $this->assertTrue(is_array($result_entities) && count($result_entities) == 4,
      '<b>Testing process without rate-type.</b><br>Process() returned an array with 4 items.');
    $this->assertTrue($result_entities[0] instanceof \Electricity, 'Items are objects of class Electricity.');

    // Make sure the same normalized entity is returned for low rate.
    $this->assertEqual($result_entities[2]->rate_type, \ElectricityNormalizerBase::LOW, 'The 3rd array element has rate type "low".');
    $this->assertEqual($result_entities[2]->id, $id, 'The existing electricity entity is used for "low" rate.');

    // Check that the values for the 3rd entity are correct.
    $this->assertEqual($result_entities[2]->type, \ElectricityNormalizerInterface::MONTH, 'Entity type is correct.');
    $this->assertEqual($result_entities[2]->timestamp, strtotime('2014-2-1 00:00'), 'Processed timestamp is correct.');
    $this->assertEqual($result_entities[2]->meter_nid, 3, 'Meter nid is correct.');
    $this->assertEqual($result_entities[2]->avg_power, 5, 'Average power calculation was correct.');
    $this->assertTrue(abs($result_entities[2]->min_power_factor - 0.90) < 0.0001, 'Min power-factor calculation was correct.');

    // Call process() without rate-type, only 2 entries for the 3/2014.
    $result_entities = $handler->process($this->meterNode3,
      array(\ElectricityNormalizerInterface::MONTH),
      array(strtotime('2014-4-1 00:00'), strtotime('2014-4-1 00:00')));

    // Should return an array of 2 objects.
    $this->assertTrue(is_array($result_entities) && count($result_entities) == 2,
      '<b>Testing process with rate-type, only 2 rate-types this time.</b><br>Process() returned an array with 2 items.');
    $this->assertTrue($result_entities[0] instanceof \Electricity, 'Items are objects of class Electricity.');

    // Check that the values for the 3rd entity are correct.
    $this->assertEqual($result_entities[0]->type, \ElectricityNormalizerInterface::MONTH, 'Entity type is correct.');
    $this->assertEqual($result_entities[0]->timestamp, strtotime('2014-3-1 00:00'), 'Processed timestamp is correct.');
    $this->assertEqual($result_entities[0]->meter_nid, 3, 'Meter nid is correct.');
    $this->assertEqual($result_entities[0]->rate_type, 'peak', 'Rate-type is correct.');
    $this->assertTrue(abs($result_entities[0]->avg_power - 2) < 0.01, 'Average power calculation was correct.');
    $this->assertTrue(abs($result_entities[0]->min_power_factor - 0.92) < 0.0001, 'Min power-factor calculation was correct.');

    // Test process() with no frequency given
    $result_entities = $handler->process($this->meterNode3,
      NULL,
      array(strtotime('2014-3-1 00:00'), strtotime('2014-3-1 00:00')));

    // Should return an array of 4 objects.
    $this->assertTrue(is_array($result_entities) && count($result_entities) == 4,
      '<b>Testing process with no rate-type nor frequency, 4 entities should be returned this time.</b><br>Process() returned an array with 4 items.');
    $this->assertTrue($result_entities[0] instanceof \Electricity, 'Items are objects of class Electricity.');

    // Check that the values for the 3rd entity are correct.
    $this->assertEqual($result_entities[2]->type, \ElectricityNormalizerInterface::MONTH, 'Entity type is correct.');
    $this->assertEqual($result_entities[2]->timestamp, strtotime('2014-2-1 00:00'), 'Processed timestamp is correct.');
    $this->assertEqual($result_entities[2]->meter_nid, 3, 'Meter nid is correct.');
    $this->assertEqual($result_entities[2]->avg_power, 5, 'Average power calculation was correct.');
    $this->assertTrue(abs($result_entities[2]->min_power_factor - 0.90) < 0.0001, 'Min power-factor calculation was correct.');

    // Test process() with time period not on time-slice borders
    $result_entities = $handler->process($this->meterNode3,
      NULL,
      array(strtotime('2014-2-12 12:34'), strtotime('2014-3-21 23:45')));

    // Should return an array of 6 objects - 4 from 2/2014, plus 2 from 3/2014.
    $this->assertTrue(is_array($result_entities) && count($result_entities) == 6,
      '<b>Testing process with no rate-type nor frequency, while time period is not on time-slice boundaries, 6 entities should be returned.</b><br>Process() returned an array with 4 items.');
    $this->assertTrue($result_entities[0] instanceof \Electricity , 'Entity 0 is an objects of class Electricity.');
    $this->assertEqual($result_entities[0]->type, \ElectricityNormalizerInterface::MONTH, 'Entity 0 type is correct.');
    $this->assertEqual($result_entities[0]->timestamp, strtotime('2014-3-1 00:00'), 'Entity 0 timestamp is correct.');
    $this->assertEqual($result_entities[0]->rate_type, 'peak', 'Entity 0 rate_type is correct.');

    $this->assertTrue($result_entities[1] instanceof \Electricity , 'Entity 1 is an objects of class Electricity.');
    $this->assertEqual($result_entities[1]->type, \ElectricityNormalizerInterface::MONTH, 'Entity 1 type is correct.');
    $this->assertEqual($result_entities[1]->timestamp, strtotime('2014-3-1 00:00'), 'Entity 1 timestamp is correct.');
    $this->assertEqual($result_entities[1]->rate_type, 'mid', 'Entity 1 rate_type is correct.');

    $this->assertEqual($result_entities[2]->type, \ElectricityNormalizerInterface::MONTH, 'Entity 2 type is correct.');
    $this->assertEqual($result_entities[2]->timestamp, strtotime('2014-2-1 00:00'), 'Entity 2 timestamp is correct.');
    $this->assertEqual($result_entities[2]->rate_type, 'peak', 'Entity 2 rate_type is correct.');
    $this->assertEqual($result_entities[2]->meter_nid, 3, 'Entity 2 Meter nid is correct.');
    $this->assertEqual($result_entities[2]->avg_power, 4, 'Average power calculation was correct.');
    $this->assertTrue(abs($result_entities[2]->min_power_factor - 0.99) < 0.0001, 'Min power-factor calculation was correct.');

    // Test process() with meter node4, which doesn't have last processed field
    $result_entities = $handler->process($this->meterNode4,
      NULL,
      array(strtotime('2014-2-12 12:34'), strtotime('2014-2-21 23:45')));

    // Should return only on entity.
    $this->assertTrue(is_array($result_entities) && count($result_entities) == 1,
      '<b>Testing process with node that doesn\'t have last processed field.</b><br>Process() returned 1 item.');
    $this->assertEqual($result_entities[0]->type, \ElectricityNormalizerInterface::MONTH, 'Entity type is correct.');
    $this->assertEqual($result_entities[0]->timestamp, strtotime('2014-2-1 00:00'), 'Entity timestamp is correct.');
    $this->assertEqual($result_entities[0]->rate_type, 'flat', 'Entity 0 rate_type is correct.');

    // Make sure node's last processed field is correct
    $wrapper = entity_metadata_wrapper('node', $this->meterNode4);
    $last_processed = $wrapper->field_last_processed->value();
    $this->assertEqual($last_processed, strtotime('2014-2-21 23:45'), 'Node last-processed field is correct.');
  }
}
